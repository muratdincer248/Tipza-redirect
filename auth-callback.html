<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Email - Tipza</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #027A4D 0%, #035a3a 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
        }
        p {
            margin: 0.5rem 0;
            opacity: 0.9;
        }
        .error {
            color: #ff6b6b;
            margin-top: 1rem;
        }
        .link {
            color: white;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Verifying your email...</h1>
        <p>Please wait while we redirect you to the app.</p>
        <p id="status">Extracting authentication tokens...</p>
        <p id="error" class="error" style="display: none;"></p>
        <p id="manual-link" style="display: none; margin-top: 1rem;">
            <a id="app-link" class="link">Click here to open the app</a>
        </p>
    </div>

    <script>
        (function() {
            // Get the current URL
            const currentUrl = window.location.href;
            console.log('Redirect page loaded. URL:', currentUrl);

            // Extract tokens from URL hash (Supabase puts them here)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');
            const type = params.get('type');
            const expiresAt = params.get('expires_at');
            const expiresIn = params.get('expires_in');
            const tokenType = params.get('token_type');

            console.log('Extracted tokens:', {
                hasAccessToken: !!accessToken,
                hasRefreshToken: !!refreshToken,
                type: type
            });

            // Determine the app deep link based on user agent or use a default
            // For development (Expo Go), we'll use a pattern that matches common setups
            // For production, use tipza://
            let deepLinkBase = 'tipza://auth/callback';
            
            // Check if we're on mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            // For development, try to detect Expo Go
            // You can customize this based on your setup
            const hostname = window.location.hostname;
            if (hostname.includes('localhost') || hostname.includes('192.168')) {
                // Try to construct Expo Go URL - you may need to adjust this
                // For now, we'll use a pattern that should work
                deepLinkBase = 'exp://192.168.2.163:8082/--/auth/callback';
            }

            if (accessToken && refreshToken) {
                // Build the deep link with tokens
                const deepLink = `${deepLinkBase}#access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}&type=${type || 'signup'}&expires_at=${expiresAt || ''}&expires_in=${expiresIn || ''}&token_type=${tokenType || 'bearer'}`;
                
                console.log('Redirecting to app:', deepLink);
                document.getElementById('status').textContent = 'Redirecting to app...';

                // Try to redirect immediately
                window.location.href = deepLink;

                // Fallback: Show manual link after a delay
                setTimeout(() => {
                    document.getElementById('status').textContent = 'If the app didn\'t open automatically:';
                    document.getElementById('manual-link').style.display = 'block';
                    document.getElementById('app-link').href = deepLink;
                    document.getElementById('app-link').onclick = function(e) {
                        e.preventDefault();
                        window.location.href = deepLink;
                    };
                }, 2000);

                // Final fallback: Try to open app after 3 seconds
                setTimeout(() => {
                    if (document.getElementById('manual-link').style.display === 'block') {
                        // App didn't open, show error
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'Unable to open app automatically. Please click the link above.';
                    }
                }, 3000);

            } else {
                // No tokens found
                console.error('No tokens found in URL');
                document.getElementById('status').textContent = 'Error: No authentication tokens found.';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'The verification link may be invalid or expired. Please try requesting a new confirmation email.';
            }

            // Also check query parameters as fallback (some email clients might modify the URL)
            if (!accessToken) {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const redirectTo = urlParams.get('redirect_to');
                
                if (token && redirectTo) {
                    // Supabase verification token - redirect to Supabase verify endpoint
                    const verifyUrl = `https://trxpdpedeivpynwnemtl.supabase.co/auth/v1/verify?token=${token}&type=signup&redirect_to=${encodeURIComponent(redirectTo)}`;
                    console.log('Redirecting to Supabase verify:', verifyUrl);
                    window.location.href = verifyUrl;
                }
            }
        })();
    </script>
</body>
</html>

