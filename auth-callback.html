/**
 * Consent Acceptance Screen
 * 
 * Full-screen blocking modal that requires users to accept Terms of Service
 * and Privacy Policy before accessing the app.
 */

import { LoadingSpinner } from '@/src/components/LoadingSpinner';
import { Button, Text } from '@/src/components/primitives';
import { LEGAL_URLS } from '@/src/constants/legal';
import { theme } from '@/src/design';
import { useAuth } from '@/src/store';
import { useRouter } from 'expo-router';
import React, { useState } from 'react';
import {
    Alert,
    KeyboardAvoidingView,
    Linking,
    Platform,
    SafeAreaView,
    ScrollView,
    StyleSheet,
    View,
} from 'react-native';

export default function ConsentScreen() {
  const router = useRouter();
  const { acceptConsent } = useAuth();
  const [isLoading, setIsLoading] = useState(false);

  const handleAccept = async () => {
    setIsLoading(true);
    try {
      await acceptConsent();
      // Navigation will be handled by auth guards after consent is accepted
      router.replace('/(tabs)/home');
    } catch (error: any) {
      Alert.alert('Error', error.message || 'Failed to save consent. Please try again.');
      setIsLoading(false);
    }
  };

  const handleOpenTerms = () => {
    Linking.openURL(LEGAL_URLS.TERMS).catch(() => {
      Alert.alert('Error', 'Unable to open Terms of Service');
    });
  };

  const handleOpenPrivacy = () => {
    Linking.openURL(LEGAL_URLS.PRIVACY).catch(() => {
      Alert.alert('Error', 'Unable to open Privacy Policy');
    });
  };

  return (
    <SafeAreaView style={styles.safeArea}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.container}
      >
        <ScrollView
          style={styles.scrollView}
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Title */}
          <View style={styles.titleSection}>
            <Text variant="display2xl" style={styles.title}>
              Terms & Privacy
            </Text>
            <Text variant="bodyMdRegular" style={styles.subtitle}>
              Please review and accept our terms to continue
            </Text>
          </View>

          {/* Content */}
          <View style={styles.contentSection}>
            <Text variant="bodyMdRegular" style={styles.contentText}>
              To use Tipza, you need to accept our Terms of Service and Privacy Policy.
              These documents explain how we handle your data and what you can expect from our service.
            </Text>

            <View style={styles.linksContainer}>
              <Text
                variant="bodyMdSemibold"
                style={styles.link}
                onPress={handleOpenTerms}
              >
                Read Terms of Service
              </Text>
              <Text
                variant="bodyMdSemibold"
                style={styles.link}
                onPress={handleOpenPrivacy}
              >
                Read Privacy Policy
              </Text>
            </View>
          </View>

          {/* Accept Button */}
          <View style={styles.buttonSection}>
            <Button
              variant="primary"
              size="medium"
              onPress={handleAccept}
              disabled={isLoading}
              style={styles.acceptButton}
            >
              {isLoading ? (
                <LoadingSpinner size={20} color={theme.colors.green['20']} />
              ) : (
                'Accept and Continue'
              )}
            </Button>
          </View>
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: theme.colors.base.flat,
  },
  container: {
    flex: 1,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    flex: 1,
    paddingHorizontal: theme.spacing['spacing-5xl'], // 24px
    paddingBottom: theme.spacing['spacing-8xl'], // 64px
    justifyContent: 'space-between',
  },
  titleSection: {
    marginTop: theme.spacing['spacing-6xl'], // 32px
    marginBottom: theme.spacing['spacing-6xl'], // 32px
  },
  title: {
    color: theme.colors.text.primary,
    marginBottom: theme.spacing['spacing-xs'], // 4px
  },
  subtitle: {
    color: theme.colors.text.secondary,
  },
  contentSection: {
    flex: 1,
    gap: theme.spacing['spacing-4xl'], // 24px
  },
  contentText: {
    color: theme.colors.text.primary,
    lineHeight: 24,
  },
  linksContainer: {
    gap: theme.spacing['spacing-l'], // 12px
    paddingVertical: theme.spacing['spacing-2xl'], // 16px
  },
  link: {
    color: theme.colors.text.primary,
    textDecorationLine: 'underline',
    fontSize: 16,
  },
  buttonSection: {
    paddingTop: theme.spacing['spacing-4xl'], // 24px
  },
  acceptButton: {
    width: '100%',
  },
});

