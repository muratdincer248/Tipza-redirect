<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Email - Tipza</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #027A4D 0%, #035a3a 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
        }
        p {
            margin: 0.5rem 0;
            opacity: 0.9;
        }
        .error {
            color: #ff6b6b;
            margin-top: 1rem;
        }
        .link {
            color: white;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Verifying your email...</h1>
        <p>Please wait while we redirect you to the app.</p>
        <p id="status">Extracting authentication tokens...</p>
        <p id="error" class="error" style="display: none;"></p>
        <p id="manual-link" style="display: none; margin-top: 1rem;">
            <a id="app-link" class="link">Click here to open the app</a>
        </p>
        <p id="expo-toggle" style="display: none; margin-top: 1rem; font-size: 0.9rem;">
            <a id="toggle-expo" class="link" style="opacity: 0.8;">Switch to Expo Go</a>
        </p>
    </div>

    <script>
        (function() {
            // Get the current URL
            const currentUrl = window.location.href;
            console.log('üîó Redirect page loaded. Full URL:', currentUrl);
            console.log('üìç Hash:', window.location.hash);
            console.log('üîç Query:', window.location.search);

            // Extract tokens from URL hash (Supabase puts them here after verification)
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            
            const accessToken = hashParams.get('access_token');
            const refreshToken = hashParams.get('refresh_token');
            const tokenType = hashParams.get('type');
            const expiresAt = hashParams.get('expires_at');
            const expiresIn = hashParams.get('expires_in');
            const tokenTypeBearer = hashParams.get('token_type');

            console.log('üîë Extracted from hash:', {
                hasAccessToken: !!accessToken,
                hasRefreshToken: !!refreshToken,
                type: tokenType,
                allHashParams: Array.from(hashParams.keys())
            });

            // Check query parameters (Supabase sends verification token first)
            const urlParams = new URLSearchParams(window.location.search);
            const verificationToken = urlParams.get('token');
            const typeParam = urlParams.get('type') || 'signup';
            const redirectTo = urlParams.get('redirect_to');
            const errorParam = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('üîç Query params:', {
                hasVerificationToken: !!verificationToken,
                type: typeParam,
                redirectTo: redirectTo,
                error: errorParam,
                allQueryParams: Array.from(urlParams.keys())
            });
            
            // PRIORITY 1: Check for Supabase errors first
            if (errorParam) {
                console.error('‚ùå Supabase error:', errorParam, errorDescription);
                document.getElementById('status').textContent = `Error: ${errorDescription || errorParam}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = errorDescription || `Authentication error: ${errorParam}`;
                return;
            }
            
            // PRIORITY 2: If we have a verification token but no access token, Supabase needs to verify it first
            // This is the normal flow: email link ‚Üí verification token ‚Üí Supabase verify ‚Üí access tokens
            if (verificationToken && !accessToken) {
                console.log('‚úÖ Verification token found, redirecting to Supabase verify endpoint...');
                document.getElementById('status').textContent = 'Verifying token with Supabase...';
                
                // Construct the current page URL that Supabase should redirect back to
                // After verification, Supabase will redirect here with tokens in the hash
                const currentUrl = window.location.origin + window.location.pathname;
                
                // Redirect to Supabase verify endpoint
                // Supabase will verify the token and redirect back to currentUrl with access_token in hash
                const verifyUrl = `https://trxpdpedeivpynwnemtl.supabase.co/auth/v1/verify?token=${encodeURIComponent(verificationToken)}&type=${encodeURIComponent(typeParam)}&redirect_to=${encodeURIComponent(currentUrl)}`;
                console.log('üîÑ Redirecting to Supabase verify:', verifyUrl);
                
                // Redirect to Supabase - it will verify and redirect back with tokens
                window.location.href = verifyUrl;
                return; // Exit early, will reload with tokens
            }
            
            // PRIORITY 3: If we have access tokens, redirect to app
            if (accessToken && refreshToken) {
                // Determine which app to use
                // Since this is accessed from GitHub Pages (development), prefer Expo Go
                const hostname = window.location.hostname;
                const isDevelopment = hostname.includes('github.io') || 
                                    hostname.includes('localhost') || 
                                    hostname.includes('192.168');
                
                // Check for explicit preference
                const preferExpo = urlParams.get('expo') === 'true' || 
                                 urlParams.get('useExpo') === 'true' ||
                                 localStorage.getItem('preferExpoGo') === 'true';
                
                const preferProduction = urlParams.get('prod') === 'true' ||
                                       urlParams.get('production') === 'true';
                
                // Build tokens string (used for both apps)
                const tokensString = `#access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}&type=${tokenType || 'signup'}&expires_at=${expiresAt || ''}&expires_in=${expiresIn || ''}&token_type=${tokenTypeBearer || 'bearer'}`;
                
                // Determine which app to use
                // Default to Expo Go when accessed from GitHub Pages (development)
                // Only use production if explicitly requested
                let useExpoGo = true; // Default to Expo Go for development
                
                if (preferProduction) {
                    useExpoGo = false;
                    console.log('üì± Using production app (explicit preference)');
                } else if (preferExpo || isDevelopment) {
                    useExpoGo = true;
                    console.log('üì± Using Expo Go (development mode)');
                } else {
                    // If not explicitly set and not on GitHub Pages, still try Expo Go first
                    // User can override with ?prod=true if needed
                    useExpoGo = true;
                    console.log('üì± Using Expo Go (default for development)');
                }
                
                // Expo Go URL - Try multiple common configurations
                // The user should update this to match their current Expo Go URL
                // Common patterns:
                // - exp://192.168.X.X:8081/--/auth/callback (default Expo port)
                // - exp://192.168.X.X:8082/--/auth/callback (custom port)
                // - exp://localhost:8081/--/auth/callback (localhost)
                
                // Try to detect from current page or use common defaults
                const possibleExpoUrls = [
                    'exp://192.168.2.163:8083/--/auth/callback',  // Your current Expo Go URL
                    'exp://192.168.2.163:8082/--/auth/callback',  // Previous port (fallback)
                    'exp://192.168.1.1:8081/--/auth/callback',    // Common router IP
                    'exp://localhost:8081/--/auth/callback',      // Localhost
                ];
                
                // Use first Expo URL (your current Expo Go URL)
                const expoGoUrl = possibleExpoUrls[0];
                const productionUrl = 'tipza://auth/callback';
                
                const deepLink = useExpoGo 
                    ? `${expoGoUrl}${tokensString}`
                    : `${productionUrl}${tokensString}`;
                
                console.log('‚úÖ Redirecting to app:', deepLink);
                console.log('üì± Using:', useExpoGo ? 'Expo Go' : 'Production');
                document.getElementById('status').textContent = useExpoGo 
                    ? 'Opening Expo Go...' 
                    : 'Opening app...';

                // Try to redirect immediately
                window.location.href = deepLink;
                
                // Fallback: Show manual link after a delay if app didn't open automatically
                setTimeout(() => {
                    if (document.getElementById('manual-link').style.display === 'none') {
                        console.log('‚ö†Ô∏è App might not have opened automatically');
                        document.getElementById('status').textContent = useExpoGo 
                            ? 'If Expo Go didn\'t open automatically:' 
                            : 'If the app didn\'t open automatically:';
                        document.getElementById('manual-link').style.display = 'block';
                        document.getElementById('app-link').href = deepLink;
                        document.getElementById('app-link').onclick = function(e) {
                            e.preventDefault();
                            window.location.href = deepLink;
                        };
                    }
                }, 2000);


                // Show toggle option for Expo Go
                const toggleExpo = document.getElementById('toggle-expo');
                const expoToggle = document.getElementById('expo-toggle');
                if (toggleExpo && expoToggle) {
                    expoToggle.style.display = 'block';
                    toggleExpo.onclick = function(e) {
                        e.preventDefault();
                        // Toggle preference
                        const preferExpo = localStorage.getItem('preferExpoGo') === 'true';
                        localStorage.setItem('preferExpoGo', (!preferExpo).toString());
                        
                        // Reload with expo parameter
                        const url = new URL(window.location);
                        url.searchParams.set('expo', (!preferExpo).toString());
                        url.hash = window.location.hash; // Preserve tokens
                        window.location.href = url.toString();
                    };
                }
                
                // Final fallback: Try to open app after 3 seconds
                setTimeout(() => {
                    if (document.getElementById('manual-link').style.display === 'block') {
                        // App didn't open, show error
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'Unable to open app automatically. Please click the link above.';
                    }
                }, 3000);
                return;
            }
            
            // PRIORITY 4: No tokens found - show error
            console.error('‚ùå No tokens found in URL');
            document.getElementById('status').textContent = 'Error: No authentication tokens found.';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'The verification link may be invalid or expired. Please try requesting a new confirmation email.';
        })();
    </script>
</body>
</html>
